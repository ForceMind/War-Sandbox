<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>War Sandbox â€” åŸå‹</title>
<style>
  :root{--bg:#0f1115;--panel:#171a21;--accent:#e2b714;--muted:#9aa4b2;--good:#3ccf91;--bad:#ff6b6b}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:#e6e9ef;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif}
  #wrap{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto;gap:8px;padding:8px}
  header,footer{display:flex;align-items:center;gap:8px;background:var(--panel);border-radius:12px;padding:8px 12px}
  header h1{font-size:16px;margin:0 8px 0 0;letter-spacing:.5px}
  header .sep{flex:1}
  button,select,input{background:#212734;color:#e6e9ef;border:1px solid #2a3242;border-radius:10px;padding:6px 10px}
  button:hover{border-color:#3a4356}
  #hud{display:flex;gap:14px;align-items:center}
  #canvasWrap{position:relative;background:#0b0d11;border-radius:12px;overflow:hidden}
  #game{display:block;width:100%;height:100%}
  #tooltip{position:absolute;pointer-events:none;left:0;top:0;background:#11161f;border:1px solid #263044;border-radius:8px;padding:6px 8px;font-size:12px;opacity:0;transition:opacity .08s}
  #bn{position:absolute;left:50%;top:12px;transform:translateX(-50%);font-weight:600;background:#11161f;border:1px solid #2a3242;border-radius:999px;padding:6px 12px;font-size:12px;opacity:.9}
  #events{display:flex;gap:8px;flex-wrap:wrap}
  .pill{background:#11161f;border:1px solid #2a3242;border-radius:999px;padding:4px 10px;font-size:12px;opacity:.9}
  .good{border-color:rgba(60,207,145,.35);color:var(--good)}
  .bad{border-color:rgba(255,107,107,.35);color:var(--bad)}
  #side{display:flex;gap:8px}
  .card{background:var(--panel);border-radius:12px;padding:10px 12px;min-width:260px}
  .card h3{margin:0 0 8px 0;font-size:14px;color:#cdd6e6}
  .row{display:flex;align-items:center;gap:8px;margin:6px 0}
  .slider{width:100%}
  .kpi{font-weight:700;color:#cdd6e6}
  .muted{color:var(--muted)}
  .hint{font-size:12px;color:#a8b3c6}
  .center{display:flex;justify-content:center;align-items:center}
</style>
</head>
<body>
<div id="wrap">
  <header>
    <h1>War Sandbox</h1>
    <div id="hud">
      <span>åŸæ±  <b id="statCities">0</b></span>
      <span>æ€»å…µåŠ› <b id="statUnits">0</b></span>
      <span>ç”¨æ—¶ <b id="statTime">0:00</b></span>
      <span>é€Ÿåº¦ <b id="statSpeed">1x</b></span>
    </div>
    <div class="sep"></div>
    <button id="btnPause" title="P">æš‚åœ</button>
    <button id="btnSpeed">Ã—2</button>
    <button id="btnMute">é™éŸ³</button>
  </header>

  <div id="canvasWrap">
    <canvas id="game"></canvas>
    <div id="tooltip"></div>
    <div id="bn">æ‹–æ‹½å·±æ–¹åŸæ±  â†’ ç›®æ ‡åŸæ±  å‘èµ·å‡ºå¾</div>
  </div>

  <footer>
    <div id="events" aria-live="polite"></div>
    <div class="sep"></div>
    <div class="hint">æ“ä½œï¼šç‚¹å‡»æˆ–æ¡†é€‰å·±æ–¹åŸæ± ï¼Œæ‹–åˆ°ç›®æ ‡åŸæ± ã€‚P æš‚åœï¼ŒÃ—2 åˆ‡æ¢å€é€Ÿã€‚</div>
  </footer>
</div>

<script>
(()=>{
'use strict';
/* =============================
   é…ç½®åŒºï¼ˆå¯è°ƒå¸¸é‡ï¼‰
============================= */
const COLORS = { PLAYER:'#4da3ff', AI1:'#ff6b6b', AI2:'#e2b714', NEUTRAL:'#7f8a9b', FOG:'#0f1115' };
const BG_GRID = true;
const TIME_SCALE_STEPS = [1,2,4];
const MAX_UNITS = 800;               // æœ€å¤§åŒæ—¶å­˜åœ¨å£«å…µæ•°é‡ï¼ˆæ€§èƒ½ä¿æŠ¤ï¼‰
const CELL = 60;                      // ç©ºé—´ç½‘æ ¼å°ºå¯¸ï¼ˆåƒç´ ï¼‰
const REVERSE = { base:0.02, max:0.08, gapFactor:0.015 }; // æ¦‚ç‡åæ€å‚æ•°
const PROJECTILE_SPEED = 320;         // è¿œç¨‹å¼¹é€Ÿåº¦
const CAPTURE_SPEED = 0.35;           // å é¢†æ¡æ¨è¿›é€Ÿåº¦ç³»æ•°
const WALL_BASE = 80;                 // åŸºç¡€åŸé˜²è€ä¹…
const PROD_TICK = 1.0;                // äº§å…µå‘¨æœŸï¼ˆç§’ï¼‰
const RALLY_PERCENT_DEFAULT = 0.5;    // é»˜è®¤æ´¾å…µæ¯”ä¾‹

const UNIT = { // å…µç§æ¨¡æ¿
  INF:{name:'æ­¥å…µ',  hp:60,  atk:8,  atkInt:0.6, move:45, range:14,  cost:1, shape:'circle'},
  CAV:{name:'éª‘å…µ',  hp:80,  atk:12, atkInt:0.7, move:70, range:14,  cost:2, shape:'triangle', charge:1.4},
  ARC:{name:'å¼“å…µ',  hp:45,  atk:7,  atkInt:0.8, move:50, range:130, cost:2, shape:'square'},
  SPE:{name:'é•¿æª',  hp:90,  atk:9,  atkInt:0.8, move:35, range:14,  cost:2, shape:'diamond'},
  SIE:{name:'æ”»åŸ',  hp:220, atk:26, atkInt:1.4, move:22, range:48,  cost:5, shape:'rect', vsWall:2.2}
};
const COUNTER = { // æ”»å‡»æ–¹â†’è¢«æ”»å‡»æ–¹ç³»æ•°
  INF:{ARC:1.25},
  CAV:{ARC:1.6},
  ARC:{INF:1.1,SPE:1.05},
  SPE:{CAV:1.8},
  SIE:{WALL:2.2}
};

// åœ°å›¾ï¼ˆä½¿ç”¨å½’ä¸€åŒ–ä½ç½®ï¼Œæ¸²æŸ“æ—¶ä¹˜ç”»å¸ƒå°ºå¯¸ï¼‰
const MAP = {
  nodes:[
    {id:1,name:'ç‹éƒ½',pos:{x:.18,y:.58},level:3,owner:'PLAYER',prod:2.0,def:1.2},
    {id:2,name:'è’åŸå ¡',pos:{x:.42,y:.24},level:2,owner:'NEUTRAL',prod:1.4,def:1.0},
    {id:3,name:'çŸ¿è„‰é•‡',pos:{x:.70,y:.58},level:2,owner:'AI1',prod:1.6,def:1.1},
    {id:4,name:'æ¸¡å£',pos:{x:.36,y:.78},level:1,owner:'NEUTRAL',prod:1.1,def:.95},
    {id:5,name:'æ—ä¸˜',pos:{x:.60,y:.35},level:1,owner:'NEUTRAL',prod:1.2,def:1.0}
  ],
  links:[[1,2],[2,3],[1,4],[4,2],[3,4],[2,5],[5,3]]
};

/* =============================
   åŸºç¡€å·¥å…·
============================= */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const lerp=(a,b,t)=>a+(b-a)*t;
const dist2=(a,b)=>{let dx=a.x-b.x,dy=a.y-b.y;return dx*dx+dy*dy};
const rand=(a,b)=>a+Math.random()*(b-a);
const nowMs=()=>performance.now();

/* =============================
   æ ¸å¿ƒçŠ¶æ€
============================= */
const state={
  t:0, dt:0, last:nowMs(), paused:false, speed:1,
  width:0,height:0, px:1,
  nodes:[], edges:[], units:[], projs:[], events:[],
  grid:null, cols:0, rows:0,
  selected:null, dragTo:null,
  rallyPercent:RALLY_PERCENT_DEFAULT,
  audio: {mute:true}
};

/* =============================
   ç”»å¸ƒåˆå§‹åŒ–ä¸è‡ªé€‚åº”
============================= */
const cvs=document.getElementById('game');
const ctx=cvs.getContext('2d');
const tooltip=document.getElementById('tooltip');
const statCities=document.getElementById('statCities');
const statUnits=document.getElementById('statUnits');
const statTime=document.getElementById('statTime');
const statSpeed=document.getElementById('statSpeed');

function resize(){
  const wrap=document.getElementById('canvasWrap');
  const w=wrap.clientWidth, h=wrap.clientHeight; 
  const dpr=window.devicePixelRatio||1; 
  cvs.width=w*dpr; cvs.height=h*dpr; cvs.style.width=w+'px'; cvs.style.height=h+'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);
  state.width=w; state.height=h; state.px=dpr;
  buildGrid();
}
window.addEventListener('resize',resize);

/* =============================
   ç©ºé—´ç½‘æ ¼
============================= */
function buildGrid(){
  state.cols=Math.ceil(state.width/CELL);
  state.rows=Math.ceil(state.height/CELL);
  state.grid=Array.from({length:state.cols*state.rows},()=>({units:[]}));
}
function cellIndex(x,y){
  const cx=Math.floor(x/CELL), cy=Math.floor(y/CELL);
  return clamp(cx,0,state.cols-1)+clamp(cy,0,state.rows-1)*state.cols;
}
function gridClear(){
  for(const c of state.grid) c.units.length=0;
}
function gridInsert(u){
  const idx=cellIndex(u.x,u.y); state.grid[idx].units.push(u); u._cell=idx;
}

/* =============================
   åœ°å›¾æ„å»º
============================= */
function buildMap(){
  state.nodes = MAP.nodes.map(n=>({
    id:n.id,name:n.name, x:n.pos.x, y:n.pos.y, level:n.level,
    owner:n.owner, prod:n.prod, def:n.def,
    wall:WALL_BASE*n.def*n.level, capture:0,
    pool:{INF:20,ARC:6,SPE:4,CAV:4,SIE:1}, // åˆå§‹å®ˆå†›ï¼ˆç¤ºæ„ï¼‰
    lastProd:0
  }));
  // å½’ä¸€åŒ–åæ ‡â†’åƒç´ 
  for(const nd of state.nodes){ nd.x*=state.width; nd.y*=state.height; }
  state.edges = MAP.links.map(([a,b])=>({a:byId(a),b:byId(b)}));
}
function byId(id){ return state.nodes.find(n=>n.id===id); }

/* =============================
   å•ä½/å¼¹é“ å¯¹è±¡æ± 
============================= */
function makeUnit(opts){ return Object.assign({
  alive:true,f:opts.f||'PLAYER',type:opts.type||'INF',
  x:opts.x,y:opts.y, vx:0,vy:0, target:null, tAtk:0, hp:UNIT[opts.type].hp,
  range:UNIT[opts.type].range, move:UNIT[opts.type].move, atk:UNIT[opts.type].atk,
  atkInt:UNIT[opts.type].atkInt, charge:UNIT[opts.type].charge||1, vsWall:UNIT[opts.type].vsWall||1,
  r:6
},opts);} 

function makeProj(x,y,tx,ty,from){
  return {x,y,tx,ty, from, alive:true, spd:PROJECTILE_SPEED};
}

/* =============================
   äº§å…µä¸æ´¾å…µ
============================= */
function nodeRadius(n){ return 28+8*(n.level-1); }
function spawnAtNode(n, f, type, count){
  for(let i=0;i<count;i++){
    if(state.units.length>=MAX_UNITS) return; 
    const ang=Math.random()*Math.PI*2, rr=nodeRadius(n)-10;
    const u=makeUnit({f,type,x:n.x+Math.cos(ang)*rr,y:n.y+Math.sin(ang)*rr});
    state.units.push(u);
  }
}
function produce(dt){
  for(const n of state.nodes){
    n.lastProd += dt * n.prod;
    if(n.lastProd>=PROD_TICK){
      n.lastProd-=PROD_TICK;
      if(n.owner!=='NEUTRAL'){
        // æ ¹æ®é…æ¯”ä» pool å†³å®šäº§å‡ºç±»å‹ï¼ˆç®€å•ï¼šæŒ‰æƒé‡éšæœºï¼‰
        const weights=n.pool; const arr=[]; for(const k in weights){ for(let i=0;i<weights[k];i++) arr.push(k); }
        const type=arr[Math.floor(Math.random()*arr.length)]||'INF';
        spawnAtNode(n,n.owner,type,1);
      }
    }
  }
}

function dispatch(from,to,percent){
  if(!from||!to||from===to) return;
  const troops=state.units.filter(u=>u.f===from.owner && dist2(u,from)<(nodeRadius(from)*nodeRadius(from)));
  const send=Math.max(1,Math.floor(troops.length*percent));
  for(let i=0;i<send;i++){
    const u=troops[i]; if(!u) break; u.target=to; // è®¾ä¸ºè¡Œå†›ç›®æ ‡
  }
  pushEvent(`å‡ºå¾ï¼š${from.name} â†’ ${to.name}ï¼ˆ${send}äººï¼‰`);
}

/* =============================
   æˆ˜æ–—ä¸å é¢†
============================= */
function counterCoef(att,def){ const tA=UNIT[att], tB=UNIT[def];
  const co=COUNTER[att]||{}; return co[def]||1;
}
function tryReverseKill(attacker, defender){
  // ä¾æ®æˆ˜åŠ›å·®è®¡ç®—å¼±è€…åæ€å‡ ç‡ï¼šå·®è·è¶Šå¤§ï¼Œå¼±è€…æ¦‚ç‡ç•¥å‡
  const aPow=attacker.atk/attacker.atkInt*attacker.hp;
  const dPow=defender.atk/defender.atkInt*defender.hp;
  let gap = Math.max(0, (aPow/dPow) - 1); // >0 è¡¨ç¤ºæ”»å‡»æ–¹æ›´å¼º
  const p = clamp(REVERSE.base + gap*REVERSE.gapFactor, REVERSE.base, REVERSE.max);
  if(Math.random()<p){ attacker.hp=0; attacker.alive=false; pushEvent('âš¡ æ¦‚ç‡åæ€ï¼', 'bad'); return true; }
  return false;
}

function updateCombat(dt){
  // ç½‘æ ¼åˆ·æ–°
  gridClear(); for(const u of state.units){ if(!u.alive) continue; gridInsert(u); }

  // å•å…µé€»è¾‘
  for(const u of state.units){ if(!u.alive) continue;
    // ç›®æ ‡é€‰æ‹©
    if(!u.target){
      // æ‰¾æœ€è¿‘æ•Œå†›
      let nearest=null, nd2=1e12; 
      // é‚»åŸŸæœç´¢ï¼ˆå½“å‰æ ¼ä¸å‘¨å›´å…«æ ¼ï¼‰
      const cx=Math.floor(u.x/CELL), cy=Math.floor(u.y/CELL);
      for(let dx=-1;dx<=1;dx++) for(let dy=-1;dy<=1;dy++){
        const ix=cx+dx, iy=cy+dy; if(ix<0||iy<0||ix>=state.cols||iy>=state.rows) continue;
        const cell=state.grid[ix+iy*state.cols];
        for(const v of cell.units){ if(!v.alive||v.f===u.f) continue; const d2=dist2(u,v); if(d2<nd2){ nd2=d2; nearest=v; } }
      }
      // è‹¥æ— æ•Œå†›ï¼Œæœæœ€è¿‘æ•Œæ–¹åŸæ± ç§»åŠ¨
      if(nearest){ u.target=nearest; } else {
        let best=null, bd2=1e12; for(const n of state.nodes){ if(n.owner!==u.f){ const d2=dist2(u,n); if(d2<bd2){bd2=d2; best=n;} } }
        u.target=best; 
      }
    }

    // ç§»åŠ¨/æ”»å‡»
    if(!u.target) continue;
    const tgt=u.target; 
    const isNode=(tgt.x===undefined?false:true)===false? false : ('wall' in tgt); // ç²—åˆ¤ï¼šèŠ‚ç‚¹å¯¹è±¡å¸¦ wall

    // è®¡ç®—è·ç¦»
    const tx=tgt.x, ty=tgt.y; const dx=tx-u.x, dy=ty-u.y; const d=Math.hypot(dx,dy);

    if(isNode){ // ç›®æ ‡ä¸ºèŠ‚ç‚¹
      const R=nodeRadius(tgt)*0.9; 
      if(d>R){ // å‰è¿›
        const sp=u.move*dt*state.speed; u.vx=dx/d*sp; u.vy=dy/d*sp; u.x+=u.vx; u.y+=u.vy;
      }else{ // è¿›å…¥åŸæ± æˆ˜æ–—ï¼šä¼˜å…ˆæ‰“åŸé˜²
        if(tgt.wall>0){
          u.tAtk-=dt*state.speed; if(u.tAtk<=0){
            const coef = (UNIT[u.type].vsWall||1) * ((COUNTER[u.type] && COUNTER[u.type].WALL)||1);
            tgt.wall -= Math.max(1, u.atk*coef);
            u.tAtk = u.atkInt;
          }
        } else {
          // ä¸å®ˆå†›/é©»å†›ä½œæˆ˜ï¼šå°±è¿‘æ•Œå†›ï¼ˆåŒæ ¼è¿‘é‚»å·²å¤„ç†ï¼‰ï¼Œè¿™é‡Œå¯æ¨è¿›å é¢†è¿›åº¦
          tgt.capture += CAPTURE_SPEED * dt * state.speed; 
          if(tgt.capture>=100){ changeOwner(tgt, u.f); }
        }
      }
    } else { // ç›®æ ‡ä¸ºæ•Œå†›
      if(d>u.range){
        const sp=u.move*dt*state.speed; u.vx=dx/d*sp; u.vy=dy/d*sp; u.x+=u.vx; u.y+=u.vy;
      } else {
        // å¯æ”»å‡»
        u.tAtk-=dt*state.speed; if(u.tAtk<=0){ u.tAtk=u.atkInt;
          if(UNIT[u.type].range>40){ // è¿œç¨‹ï¼šå‘å°„å¼¹ä½“
            state.projs.push(makeProj(u.x,u.y,tgt.x,tgt.y,u));
          } else { // è¿‘æˆ˜ï¼šç›´æ¥ç»“ç®—å¹¶å°è¯•åæ€
            let dmg=u.atk * counterCoef(u.type, tgt.type);
            if(u.type==='CAV') dmg*=u.charge; 
            // ç›®æ ‡å°è¯•åæ€
            const killed = tryReverseKill(u,tgt); if(!killed){ tgt.hp-=dmg; if(tgt.hp<=0){ tgt.alive=false; pushEvent('å‡»æ€ +1','good'); u.target=null; } }
          }
        }
      }
    }
  }

  // å¼¹é“æ›´æ–°
  for(const p of state.projs){ if(!p.alive) continue; 
    const dx=p.tx-p.x, dy=p.ty-p.y; const d=Math.hypot(dx,dy);
    if(d<6){ // å‘½ä¸­
      // æ‰¾åˆ°é‚»è¿‘æ•Œå†›ï¼ˆåŠå¾„ 20ï¼‰
      let hit=null, nd2=400; for(const u of state.units){ if(!u.alive||u.f===p.from.f) continue; const d2=dist2(u,p); if(d2<nd2){ nd2=d2; hit=u; } }
      if(hit){
        let dmg=p.from.atk * counterCoef(p.from.type, hit.type);
        hit.hp-=dmg; if(hit.hp<=0){ hit.alive=false; pushEvent('è¿œç¨‹å‡»æ€','good'); }
      }
      p.alive=false; continue;
    }
    const sp=p.spd*dt*state.speed; p.x+=dx/d*sp; p.y+=dy/d*sp;
  }

  // æ¸…ç†æ­»äº¡
  state.units=state.units.filter(u=>u.alive);
  state.projs=state.projs.filter(p=>p.alive);
}

function changeOwner(node, newOwner){
  node.owner=newOwner; node.capture=0; node.wall=WALL_BASE*node.def*node.level;
  pushEvent(`ğŸ³ï¸ å é¢† ${node.name} æˆåŠŸ`, 'good');
}

/* =============================
   AI é€»è¾‘ï¼ˆæç®€å¯ç©ï¼‰
============================= */
let aiTimer=0;
function updateAI(dt){
  aiTimer-=dt*state.speed; if(aiTimer>0) return; aiTimer=rand(2,4); // æ¯ 2~4 ç§’å†³ç­–ä¸€æ¬¡
  const aiNodes=state.nodes.filter(n=>n.owner.startsWith('AI'));
  const targets=state.nodes.filter(n=>n.owner!=='AI1');
  if(aiNodes.length===0) return;
  const src=aiNodes[Math.floor(Math.random()*aiNodes.length)];
  // é€‰æ‹©æœ€è¿‘çš„ä¸­ç«‹æˆ–ç©å®¶åŸ
  let best=null, bd2=1e12; for(const t of targets){ if(t===src) continue; const d2=dist2(src,t); if(d2<bd2){bd2=d2;best=t;} }
  if(best){ dispatch(src,best,0.5); }
}

/* =============================
   æ¸²æŸ“
============================= */
function drawGrid(){
  if(!BG_GRID) return; ctx.save(); ctx.strokeStyle='#12151b'; ctx.lineWidth=1;
  for(let x=0;x<state.width;x+=CELL){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,state.height); ctx.stroke(); }
  for(let y=0;y<state.height;y+=CELL){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(state.width,y); ctx.stroke(); }
  ctx.restore();
}
function drawEdges(){ ctx.save(); ctx.strokeStyle='#1e242f'; ctx.lineWidth=2; for(const e of state.edges){ ctx.beginPath(); ctx.moveTo(e.a.x,e.a.y); ctx.lineTo(e.b.x,e.b.y); ctx.stroke(); } ctx.restore(); }
function drawNodes(){
  for(const n of state.nodes){
    const R=nodeRadius(n);
    ctx.save();
    // åœˆä¸å¡«è‰²
    ctx.beginPath(); ctx.arc(n.x,n.y,R,0,Math.PI*2);
    ctx.fillStyle = (n.owner==='PLAYER')? '#0d2740' : (n.owner==='AI1')? '#401a1a' : (n.owner==='AI2')? '#3c3310' : '#1f2430';
    ctx.fill(); ctx.lineWidth=3; ctx.strokeStyle=(COLORS[n.owner]||'#4b5565'); ctx.stroke();

    // å é¢†è¿›åº¦
    if(n.owner!=='NEUTRAL' && n.capture>0){
      ctx.beginPath(); ctx.strokeStyle='#d6e0f5'; ctx.lineWidth=4;
      ctx.arc(n.x,n.y,R+4,-Math.PI/2,-Math.PI/2+Math.min(1,n.capture/100)*Math.PI*2);
      ctx.stroke();
    }

    // åŸé˜²æ¡
    const wallPct=clamp(n.wall/(WALL_BASE*n.def*n.level),0,1);
    const bw=R*1.5, bh=6; ctx.fillStyle='#12161f'; ctx.fillRect(n.x-bw/2,n.y+R+8,bw,bh);
    ctx.fillStyle=wallPct>0.5?'#39d0a8':'#f1c40f'; ctx.fillRect(n.x-bw/2,n.y+R+8,bw*wallPct,bh);

    // åç§°
    ctx.fillStyle='#cdd6e6'; ctx.font='12px system-ui'; ctx.textAlign='center';
    ctx.fillText(`${n.name} Lv${n.level}`, n.x, n.y-R-8);
    ctx.restore();
  }
}
function drawUnits(){
  for(const u of state.units){ ctx.save(); ctx.translate(u.x,u.y);
    ctx.fillStyle = (COLORS[u.f]||'#8899aa');
    switch(UNIT[u.type].shape){
      case 'circle': ctx.beginPath(); ctx.arc(0,0,3.5,0,Math.PI*2); ctx.fill(); break;
      case 'triangle': ctx.beginPath(); ctx.moveTo(0,-4); ctx.lineTo(4,4); ctx.lineTo(-4,4); ctx.closePath(); ctx.fill(); break;
      case 'square': ctx.fillRect(-3,-3,6,6); break;
      case 'diamond': ctx.beginPath(); ctx.moveTo(0,-4); ctx.lineTo(4,0); ctx.lineTo(0,4); ctx.lineTo(-4,0); ctx.closePath(); ctx.fill(); break;
      case 'rect': ctx.fillRect(-5,-3,10,6); break;
    }
    ctx.restore();
  }
  // å¼¹é“
  ctx.save(); ctx.strokeStyle='#d8dee9'; ctx.lineWidth=1.5; for(const p of state.projs){ ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(p.tx,p.ty); ctx.stroke(); } ctx.restore();
}

function render(){
  ctx.clearRect(0,0,state.width,state.height);
  drawGrid(); drawEdges(); drawNodes(); drawUnits();
  // æ‹–æ‹½æç¤ºç®­å¤´
  if(state.selected && state.dragTo){
    const a=state.selected, b=state.dragTo; ctx.save(); ctx.strokeStyle='#d6e0f5'; ctx.setLineDash([6,4]); ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke(); ctx.setLineDash([]);
    ctx.restore();
  }
}

/* =============================
   äº‹ä»¶/æç¤º
============================= */
const eventsEl=document.getElementById('events');
function pushEvent(text,type){
  const span=document.createElement('span'); span.className='pill'+(type?(' '+type):''); span.textContent=text; eventsEl.prepend(span);
  setTimeout(()=>span.remove(), 4200);
}

/* =============================
   ä¸»å¾ªç¯
============================= */
function tick(){
  const t=nowMs(); const raw=(t-state.last)/1000; state.last=t; state.dt=raw; if(state.paused){ render(); requestAnimationFrame(tick); return; }
  const dt=state.dt; // çœŸå® dtï¼Œé€Ÿåº¦åœ¨å„ç³»ç»Ÿé‡Œä¹˜
  state.t+=dt*state.speed;

  produce(dt);
  updateAI(dt);
  updateCombat(dt);
  render();
  updateHUD();
  requestAnimationFrame(tick);
}

function updateHUD(){
  const timeSec=Math.floor(state.t); const m=Math.floor(timeSec/60), s=timeSec%60; statTime.textContent=`${m}:${s.toString().padStart(2,'0')}`;
  statUnits.textContent=state.units.length.toString();
  const myCities=state.nodes.filter(n=>n.owner==='PLAYER').length; statCities.textContent=myCities.toString();
  statSpeed.textContent = state.speed+'x';
}

/* =============================
   äº¤äº’ï¼šé€‰æ‹©ä¸æ‹–æ‹½æ´¾å…µ
============================= */
let mouse={x:0,y:0, down:false};
function pickNodeAt(x,y){ for(const n of state.nodes){ if(Math.hypot(x-n.x,y-n.y)<=nodeRadius(n)) return n; } return null; }

cvs.addEventListener('mousemove',e=>{
  const rect=cvs.getBoundingClientRect(); mouse.x=e.clientX-rect.left; mouse.y=e.clientY-rect.top;
  const n=pickNodeAt(mouse.x,mouse.y);
  if(n){ tooltip.style.opacity=1; tooltip.style.transform=`translate(${mouse.x+12}px,${mouse.y+12}px)`;
    tooltip.innerHTML=`<b>${n.name}</b> Lv${n.level}<br>æ‰€å±ï¼š${n.owner}<br>äº§å…µï¼š${n.prod.toFixed(2)}/s<br>åŸé˜²ï¼š${Math.round(n.wall)}`;
  } else { tooltip.style.opacity=0; }
  if(mouse.down && state.selected){ state.dragTo=n; }
});

cvs.addEventListener('mousedown',e=>{ mouse.down=true; const n=pickNodeAt(mouse.x,mouse.y); if(n && n.owner==='PLAYER'){ state.selected=n; } });

cvs.addEventListener('mouseup',e=>{ mouse.down=false; const n=pickNodeAt(mouse.x,mouse.y); if(state.selected && n){ if(n!==state.selected){ dispatch(state.selected,n,state.rallyPercent); } }
  state.selected=null; state.dragTo=null; });

/* =============================
   æ§ä»¶/å¿«æ·é”®
============================= */
const btnPause=document.getElementById('btnPause');
const btnSpeed=document.getElementById('btnSpeed');
const btnMute=document.getElementById('btnMute');
let speedIdx=0;
btnPause.onclick=()=>{ state.paused=!state.paused; btnPause.textContent=state.paused?'ç»§ç»­':'æš‚åœ'; };
btnSpeed.onclick=()=>{ speedIdx=(speedIdx+1)%TIME_SCALE_STEPS.length; state.speed=TIME_SCALE_STEPS[speedIdx]; btnSpeed.textContent='Ã—'+TIME_SCALE_STEPS[(speedIdx+1)%TIME_SCALE_STEPS.length]; };
btnMute.onclick=()=>{ state.audio.mute=!state.audio.mute; btnMute.textContent=state.audio.mute?'é™éŸ³':'å·²é™éŸ³'; };
window.addEventListener('keydown',e=>{
  if(e.key==='p' || e.key==='P') btnPause.click();
});

/* =============================
   å¯åŠ¨
============================= */
function start(){ resize(); buildMap(); pushEvent('æ¬¢è¿æŒ‡æŒ¥å®˜ï¼Œæ‹–æ‹½å·±æ–¹åŸæ± å‘èµ·å‡ºå¾'); requestAnimationFrame(tick); }
start();

})();
</script>
</html>
